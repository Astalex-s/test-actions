# Инструкция по настройке деплоя

## Необходимые секреты GitHub

Для работы workflow необходимо добавить следующие секреты в настройках репозитория:
**Settings → Secrets and variables → Actions → New repository secret**

### 1. SSH_PRIVATE_KEY
Приватный SSH ключ для подключения к серверу.

**Как получить:**
```bash
# Если ключа нет, создайте его:
ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/github_actions

# Скопируйте приватный ключ:
cat ~/.ssh/github_actions
```

**Важно:** Добавьте публичный ключ на сервер:
```bash
# На вашем компьютере:
cat ~/.ssh/github_actions.pub

# На сервере добавьте в ~/.ssh/authorized_keys:
echo "ваш_публичный_ключ" >> ~/.ssh/authorized_keys
```

### 2. SSH_HOST
IP-адрес или доменное имя вашего сервера.

**Пример:** `192.168.1.100` или `example.com`

### 3. SSH_USER
Имя пользователя для SSH подключения.

**Пример:** `root` или `deploy`

## Требования к серверу

1. **Docker должен быть установлен:**
   ```bash
   curl -fsSL https://get.docker.com -o get-docker.sh
   sh get-docker.sh
   ```

2. **Пользователь должен иметь права на выполнение Docker команд:**
   ```bash
   sudo usermod -aG docker $USER
   ```

3. **SSH доступ должен быть настроен** (публичный ключ добавлен в `~/.ssh/authorized_keys`)

## Как это работает

1. **Первая джоба (build-and-push):**
   - Собирает Docker образ из Dockerfile
   - Пушит образ в GitHub Container Registry (ghcr.io)
   - Тегирует образ как `latest` и с SHA коммита

2. **Вторая джоба (deploy):**
   - Подключается к серверу по SSH
   - Логинится в GitHub Container Registry
   - Останавливает и удаляет старый контейнер
   - Скачивает новый образ
   - Запускает новый контейнер на порту 8000

## Запуск workflow

Workflow автоматически запускается при:
- Push в ветку `main`
- Ручном запуске через **Actions → Build and Deploy → Run workflow**

## Проверка деплоя

После успешного деплоя приложение будет доступно по адресу:
- `http://ваш_сервер:8000`
- `http://ваш_сервер:8000/time` - текущее время
- `http://ваш_сервер:8000/date` - текущая дата
- `http://ваш_сервер:8000/docs` - интерактивная документация

## Устранение проблем

### Ошибка подключения по SSH
- Проверьте, что SSH ключ добавлен правильно
- Убедитесь, что сервер доступен из интернета
- Проверьте настройки firewall

### Ошибка доступа к Docker
- Убедитесь, что пользователь в группе `docker`
- Проверьте права на выполнение Docker команд

### Ошибка авторизации в GHCR
- Убедитесь, что `GITHUB_TOKEN` доступен (должен быть автоматически)
- Проверьте, что репозиторий имеет права на запись пакетов

